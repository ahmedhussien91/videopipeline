name: CI

on:
  push:
  pull_request:

jobs:
  build-native:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake pkg-config libyaml-cpp-dev

      - name: Build (native)
        run: ./scripts/vp.sh build native --build-dir build/native

      - name: Smoke test (local run)
        run: ./scripts/vp.sh run local --bin build/native/pipeline_cli --config examples/test_pattern_to_file.conf --time 1 --no-stats

  build-cross-aarch64:
    runs-on: ubuntu-latest
    env:
      YOCTO_SDK_URL: ${{ secrets.YOCTO_SDK_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake pkg-config

      - name: Download Yocto SDK
        run: |
          if [ -z "${YOCTO_SDK_URL}" ]; then
            echo "YOCTO_SDK_URL secret not set; cannot download SDK" >&2
            exit 1
          fi
          curl -L "${YOCTO_SDK_URL}" -o /tmp/yocto-sdk
          FILETYPE="$(file -b /tmp/yocto-sdk)"
          echo "SDK file type: ${FILETYPE}"
          mkdir -p /tmp/yocto-sdk-root
          if echo "${FILETYPE}" | grep -qi "gzip compressed data"; then
            tar -xzf /tmp/yocto-sdk -C /tmp/yocto-sdk-root
          elif echo "${FILETYPE}" | grep -qi "xz compressed data"; then
            tar -xJf /tmp/yocto-sdk -C /tmp/yocto-sdk-root
          elif echo "${FILETYPE}" | grep -qi "POSIX shell script"; then
            chmod +x /tmp/yocto-sdk
            /tmp/yocto-sdk -y -d /tmp/yocto-sdk-root
          elif echo "${FILETYPE}" | grep -qi "ELF 64-bit LSB executable"; then
            chmod +x /tmp/yocto-sdk
            /tmp/yocto-sdk -y -d /tmp/yocto-sdk-root
          else
            echo "Unsupported SDK payload type: ${FILETYPE}" >&2
            exit 1
          fi

      - name: Build (Yocto cross)
        run: |
          SDK_ENV=$(ls /tmp/yocto-sdk-root/poky/5.0.8/environment-setup-* 2>/dev/null | head -n1)
          if [ ! -f "${SDK_ENV}" ]; then
            echo "environment-setup-* not found in /tmp/yocto-sdk-root" >&2
            exit 1
          fi
          source "${SDK_ENV}"
          ./scripts/vp.sh build yocto --sdk-env "${SDK_ENV}" --build-dir build/rpi-yocto-ci

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t camera-pipeline -f docker/Dockerfile .
